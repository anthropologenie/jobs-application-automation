<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Learning & Interview Tracker</title>
    <link rel="stylesheet" href="dashboard/styles.css">
    <style>
        .add-question-btn {
            background: #16a34a;
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
        }
        .add-question-btn:hover {
            background: #15803d;
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>üìö Learning & Interview Tracker</h1>
            <div class="header-actions">
                <button onclick="location.reload()" class="btn-refresh">üîÑ Refresh</button>
                <button onclick="showAddQuestionModal()" class="add-question-btn">‚ûï Add Question</button>
                <a href="http://localhost:8082" class="btn-add" style="text-decoration: none;">üè† Main Dashboard</a>
            </div>
        </header>

        <section class="metrics">
            <div class="metric-card">
                <div class="metric-label">Weak Areas</div>
                <div class="metric-value" id="weak-count">0</div>
            </div>
            <div class="metric-card">
                <div class="metric-label">Study Topics</div>
                <div class="metric-value" id="topic-count">0</div>
            </div>
            <div class="metric-card">
                <div class="metric-label">Questions Logged</div>
                <div class="metric-value" id="question-count">0</div>
            </div>
            <div class="metric-card">
                <div class="metric-label">Study Hours</div>
                <div class="metric-value" id="study-hours">0</div>
            </div>
        </section>

        <!-- SQL PRACTICE STATS - NEW SECTION -->
        <section class="pipeline">
            <h2>üíª SQL Practice Stats</h2>
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; padding: 20px;">
                <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 20px; border-radius: 12px; box-shadow: 0 4px 6px rgba(0,0,0,0.1);">
                    <div style="font-size: 14px; opacity: 0.9;">Total Sessions</div>
                    <div style="font-size: 36px; font-weight: bold;" id="practice-total">0</div>
                </div>
                <div style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); color: white; padding: 20px; border-radius: 12px; box-shadow: 0 4px 6px rgba(0,0,0,0.1);">
                    <div style="font-size: 14px; opacity: 0.9;">Accuracy</div>
                    <div style="font-size: 36px; font-weight: bold;" id="practice-accuracy">0%</div>
                </div>
                <div style="background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%); color: white; padding: 20px; border-radius: 12px; box-shadow: 0 4px 6px rgba(0,0,0,0.1);">
                    <div style="font-size: 14px; opacity: 0.9;">Practice Time</div>
                    <div style="font-size: 36px; font-weight: bold;" id="practice-minutes">0min</div>
                </div>
                <div style="background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%); color: white; padding: 20px; border-radius: 12px; box-shadow: 0 4px 6px rgba(0,0,0,0.1);">
                    <div style="font-size: 14px; opacity: 0.9;">Platforms Used</div>
                    <div style="font-size: 36px; font-weight: bold;" id="practice-platforms">0</div>
                </div>
            </div>

            <!-- Difficulty Breakdown -->
            <div style="padding: 0 20px 20px 20px;">
                <h3 style="margin-bottom: 10px;">Difficulty Breakdown</h3>
                <div style="display: flex; gap: 15px; background: #f8fafc; padding: 15px; border-radius: 8px;">
                    <div style="flex: 1; text-align: center;">
                        <div style="color: #10b981; font-size: 24px; font-weight: bold;" id="practice-easy">0</div>
                        <div style="color: #64748b; font-size: 12px;">Easy</div>
                    </div>
                    <div style="flex: 1; text-align: center;">
                        <div style="color: #f59e0b; font-size: 24px; font-weight: bold;" id="practice-medium">0</div>
                        <div style="color: #64748b; font-size: 12px;">Medium</div>
                    </div>
                    <div style="flex: 1; text-align: center;">
                        <div style="color: #dc2626; font-size: 24px; font-weight: bold;" id="practice-hard">0</div>
                        <div style="color: #64748b; font-size: 12px;">Hard</div>
                    </div>
                </div>
            </div>
        </section>

        <!-- SQL KEYWORDS MASTERY -->
        <section class="pipeline">
            <h2>üîë SQL Keywords Mastery</h2>
            <div id="keywords-container" style="padding: 20px;">
                <p class="empty-state">No practice data yet. Use ./log-sql-practice.py to start!</p>
            </div>
        </section>

        <!-- COMMON MISTAKES -->
        <section class="pipeline">
            <h2>‚ö†Ô∏è Common Mistakes to Avoid</h2>
            <div id="mistakes-container" style="padding: 20px;">
                <p class="empty-state">No mistakes logged yet</p>
            </div>
        </section>

        <section class="pipeline">
            <h2>üéØ Learning Gaps (What You Struggled With)</h2>
            <div id="gaps-container" style="padding: 20px;">
                <p class="empty-state">Loading...</p>
            </div>
        </section>

        <section class="pipeline">
            <h2>üìö Study Priority Queue</h2>
            <div class="pipeline-table-wrapper">
                <table>
                    <thead>
                        <tr>
                            <th>Topic</th>
                            <th>Category</th>
                            <th>Priority</th>
                            <th>Progress</th>
                            <th>Deadline</th>
                        </tr>
                    </thead>
                    <tbody id="study-body">
                        <tr><td colspan="5" class="empty-state">Loading...</td></tr>
                    </tbody>
                </table>
            </div>
        </section>

        <section class="pipeline">
            <h2>‚ùì Your Interview Questions</h2>
            <div class="pipeline-table-wrapper">
                <table>
                    <thead>
                        <tr>
                            <th>Question</th>
                            <th>Type</th>
                            <th>Company</th>
                            <th>Difficulty</th>
                            <th>Your Rating</th>
                            <th>Tags</th>
                        </tr>
                    </thead>
                    <tbody id="questions-body">
                        <tr><td colspan="6" class="empty-state">Loading...</td></tr>
                    </tbody>
                </table>
            </div>
        </section>
    </div>

    <!-- Add Question Modal -->
    <div id="add-modal" class="modal" style="display: none;">
        <div class="modal-content">
            <span class="close" onclick="closeAddQuestionModal()">&times;</span>
            <h2>Add Interview Question</h2>
            <form id="add-question-form" onsubmit="addQuestion(event)">
                <div class="form-group">
                    <label>Question Text *</label>
                    <textarea id="question-text" rows="3" required placeholder="Enter the interview question..."></textarea>
                </div>
                
                <div class="form-group">
                    <label>Question Type *</label>
                    <select id="question-type" required>
                        <option value="">-- Select Type --</option>
                        <option value="Technical SQL">Technical SQL</option>
                        <option value="Data Warehouse">Data Warehouse</option>
                        <option value="ETL Tools">ETL Tools</option>
                        <option value="Python">Python</option>
                        <option value="System Design">System Design</option>
                        <option value="Behavioral">Behavioral</option>
                        <option value="Cloud Services">Cloud Services</option>
                        <option value="Architecture">Architecture</option>
                        <option value="Coding">Coding</option>
                    </select>
                </div>

                <div class="form-group">
                    <label>Difficulty *</label>
                    <select id="difficulty" required>
                        <option value="">-- Select Difficulty --</option>
                        <option value="Easy">Easy</option>
                        <option value="Medium" selected>Medium</option>
                        <option value="Hard">Hard</option>
                    </select>
                </div>

                <div class="form-group">
                    <label>Company (Optional)</label>
                    <select id="company-select">
                        <option value="">-- Not linked to company --</option>
                    </select>
                </div>

                <div class="form-group">
                    <label>Your Rating (1-5) *</label>
                    <div style="display: flex; gap: 10px; align-items: center;">
                        <input type="range" id="rating" min="1" max="5" value="3" style="flex: 1;">
                        <span id="rating-display" style="font-weight: bold; font-size: 18px;">3</span>
                    </div>
                    <small style="color: #64748b;">1 = Struggled heavily, 5 = Answered perfectly</small>
                </div>

                <div class="form-group">
                    <label>Tags (comma-separated)</label>
                    <input type="text" id="tags" placeholder="sql, window-functions, optimization">
                </div>

                <div class="form-group">
                    <label>My Response (Optional)</label>
                    <textarea id="my-response" rows="3" placeholder="What you answered..."></textarea>
                </div>

                <div class="form-group">
                    <label>Ideal Response (Optional)</label>
                    <textarea id="ideal-response" rows="3" placeholder="What the correct answer should be..."></textarea>
                </div>

                <button type="submit" class="btn-primary">üíæ Save Question</button>
            </form>
        </div>
    </div>

    <script>
        const API = 'http://localhost:8081/api';

        // Update rating display
        document.getElementById('rating').addEventListener('input', (e) => {
            document.getElementById('rating-display').textContent = e.target.value;
        });

        async function loadData() {
            try {
                const [gaps, topics, questions, companies, practiceStats, keywords, mistakes] = await Promise.all([
                    fetch(`${API}/learning-gaps`).then(r => r.json()),
                    fetch(`${API}/study-priority`).then(r => r.json()),
                    fetch(`${API}/recent-questions`).then(r => r.json()),
                    fetch(`${API}/pipeline`).then(r => r.json()),
                    fetch(`${API}/sql-practice-stats`).then(r => r.json()),
                    fetch(`${API}/sql-keyword-mastery`).then(r => r.json()),
                    fetch(`${API}/common-mistakes`).then(r => r.json())
                ]);

                // Populate company dropdown
                const companySelect = document.getElementById('company-select');
                companySelect.innerHTML = '<option value="">-- Not linked to company --</option>' +
                    companies.map(c => `<option value="${c.id}">${c.company}</option>`).join('');

                // Update metrics
                document.getElementById('weak-count').textContent = gaps.filter(g => g.weak_percentage > 50).length;
                document.getElementById('topic-count').textContent = topics.length;
                document.getElementById('question-count').textContent = questions.length;
                document.getElementById('study-hours').textContent = Math.round(topics.reduce((sum, t) => sum + (t.total_study_hours || 0), 0));

                // Update SQL practice stats
                document.getElementById('practice-total').textContent = practiceStats.total_sessions || 0;
                document.getElementById('practice-accuracy').textContent = (practiceStats.accuracy_percentage || 0) + '%';
                document.getElementById('practice-minutes').textContent = (practiceStats.total_minutes || 0) + 'min';
                document.getElementById('practice-platforms').textContent = practiceStats.platforms_used || 0;
                document.getElementById('practice-easy').textContent = practiceStats.easy_count || 0;
                document.getElementById('practice-medium').textContent = practiceStats.medium_count || 0;
                document.getElementById('practice-hard').textContent = practiceStats.hard_count || 0;

                // Render gaps
                const gapsContainer = document.getElementById('gaps-container');
                if (gaps.length === 0) {
                    gapsContainer.innerHTML = '<p class="empty-state">No learning gaps yet</p>';
                } else {
                    gapsContainer.innerHTML = gaps.map(g => `
                        <div style="background: ${g.avg_performance <= 2 ? '#fef2f2' : '#f0fdf4'}; padding: 15px; margin: 10px 0; border-left: 4px solid ${g.avg_performance <= 2 ? '#dc2626' : '#16a34a'}; border-radius: 8px;">
                            <strong>${g.question_type}</strong> (${g.difficulty})<br>
                            <small>Performance: ${g.avg_performance.toFixed(1)}/5 ‚≠ê | Questions: ${g.question_count} | Weak: ${g.weak_percentage}%</small>
                        </div>
                    `).join('');
                }

                // Render study topics
                const studyBody = document.getElementById('study-body');
                studyBody.innerHTML = topics.map(t => `
                    <tr>
                        <td><strong>${t.name}</strong></td>
                        <td>${t.category}</td>
                        <td><span style="background: ${t.priority >= 5 ? '#dc2626' : t.priority >= 4 ? '#f59e0b' : '#0ea5e9'}; color: white; padding: 4px 8px; border-radius: 6px; font-size: 12px;">${t.priority}/5</span></td>
                        <td>${t.progress_percentage || 0}% (${t.total_study_hours || 0}h / ${t.estimated_hours}h)</td>
                        <td>${t.deadline || 'No deadline'}</td>
                    </tr>
                `).join('');

                // Render questions
                const questionsBody = document.getElementById('questions-body');
                questionsBody.innerHTML = questions.map(q => `
                    <tr>
                        <td style="max-width: 350px;">${q.question_text}</td>
                        <td>${q.question_type}</td>
                        <td>${q.company || 'N/A'}</td>
                        <td><span class="status-badge status-${q.difficulty.toLowerCase()}">${q.difficulty}</span></td>
                        <td>${'‚≠ê'.repeat(q.my_rating || 0)}${'‚òÜ'.repeat(5 - (q.my_rating || 0))}</td>
                        <td><small>${q.tags || 'No tags'}</small></td>
                    </tr>
                `).join('');

                // Render SQL Keywords Mastery
                const keywordsContainer = document.getElementById('keywords-container');
                if (keywords.length === 0) {
                    keywordsContainer.innerHTML = '<p class="empty-state">No practice data yet. Use ./log-sql-practice.py to start!</p>';
                } else {
                    keywordsContainer.innerHTML = '<div style="display: flex; flex-wrap: wrap; gap: 12px;">' +
                        keywords.slice(0, 10).map(k => {
                            const color = k.accuracy_percentage >= 80 ? '#10b981' : k.accuracy_percentage >= 60 ? '#f59e0b' : '#dc2626';
                            return `
                                <div style="background: white; border: 2px solid ${color}; border-radius: 8px; padding: 12px 16px; min-width: 150px;">
                                    <div style="font-weight: bold; color: ${color}; font-size: 16px;">${k.keyword}</div>
                                    <div style="font-size: 12px; color: #64748b; margin-top: 4px;">
                                        ${k.practice_count} practices | ${k.accuracy_percentage}% accuracy
                                    </div>
                                </div>
                            `;
                        }).join('') + '</div>';
                }

                // Render Common Mistakes
                const mistakesContainer = document.getElementById('mistakes-container');
                if (mistakes.length === 0) {
                    mistakesContainer.innerHTML = '<p class="empty-state">No mistakes logged yet</p>';
                } else {
                    mistakesContainer.innerHTML = mistakes.map(m => `
                        <div style="background: #fef2f2; border-left: 4px solid #dc2626; padding: 15px; margin: 10px 0; border-radius: 8px;">
                            <div style="font-weight: bold; color: #dc2626; margin-bottom: 5px;">
                                ‚ö†Ô∏è ${m.error_made} <span style="background: #dc2626; color: white; padding: 2px 8px; border-radius: 12px; font-size: 11px; margin-left: 8px;">${m.occurrence_count}x</span>
                            </div>
                            <div style="font-size: 12px; color: #64748b;">
                                Concepts: ${m.concepts_affected || 'Various'} | Avg recovery time: ${m.avg_recovery_time || 'N/A'}min
                            </div>
                        </div>
                    `).join('');
                }
            } catch (error) {
                console.error('Error loading data:', error);
                alert('Error loading data. Make sure API server is running.');
            }
        }

        function showAddQuestionModal() {
            document.getElementById('add-modal').style.display = 'block';
        }

        function closeAddQuestionModal() {
            document.getElementById('add-modal').style.display = 'none';
            document.getElementById('add-question-form').reset();
            document.getElementById('rating-display').textContent = '3';
        }

        async function addQuestion(event) {
            event.preventDefault();

            const companyId = document.getElementById('company-select').value;
            
            const data = {
                opportunity_id: companyId || null,
                question_text: document.getElementById('question-text').value,
                question_type: document.getElementById('question-type').value,
                difficulty: document.getElementById('difficulty').value,
                my_rating: parseInt(document.getElementById('rating').value),
                tags: document.getElementById('tags').value,
                my_response: document.getElementById('my-response').value,
                ideal_response: document.getElementById('ideal-response').value
            };

            try {
                const response = await fetch(`${API}/add-question`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });

                const result = await response.json();

                if (result.success) {
                    alert('‚úÖ Question added successfully!');
                    closeAddQuestionModal();
                    loadData();
                } else {
                    alert('‚ùå Error: ' + (result.error || 'Unknown error'));
                }
            } catch (error) {
                console.error('Error adding question:', error);
                alert('‚ùå Error connecting to server. Make sure API is running on port 8081.');
            }
        }

        // Close modal on outside click
        window.onclick = function(event) {
            const modal = document.getElementById('add-modal');
            if (event.target === modal) {
                closeAddQuestionModal();
            }
        }

        // Load on page load
        loadData();
        setInterval(loadData, 2 * 60 * 1000);
    </script>
</body>
</html>
